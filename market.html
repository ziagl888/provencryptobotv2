<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Proven Crypto Dashboard</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg-color: #0d0d0d;
            --card-bg: #1a1a1a;
            --text-main: #ffffff;
            --text-sec: #888888;
            --accent: #00ffff;
            --green: #00ff88;
            --red: #ff3040;
            --orange: #ffaa00;
            --purple: #bb86fc;
        }
        body {
            margin: 0; padding: 16px;
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            min-height: 100vh;
        }
        .main-card {
            background: linear-gradient(145deg, #1e1e1e, #141414);
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            border: 1px solid #333;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            margin-bottom: 20px;
        }
        .sentiment-label { font-size: 14px; color: var(--text-sec); text-transform: uppercase; letter-spacing: 1px; }
        .sentiment-value { font-size: 32px; font-weight: 800; margin: 10px 0; text-shadow: 0 0 15px rgba(0,255,255,0.3); }

        h3 {
            margin: 24px 0 12px 0;
            font-size: 17px;
            color: var(--accent);
            border-bottom: 1px solid #333;
            padding-bottom: 6px;
        }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px; }
        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 14px;
            font-size: 15px;
        }
        .label { font-size: 12px; color: var(--text-sec); margin-bottom: 4px; }
        .value { font-size: 18px; font-weight: 600; }
        .sub { font-size: 13px; margin-top: 4px; }

        .green { color: var(--green); }
        .red { color: var(--red); }
        .orange { color: var(--orange); }

        .list {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 16px;
        }
        .item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #333;
            font-size: 15px;
        }
        .item:last-child { border-bottom: none; }
        .rank { font-weight: bold; color: var(--accent); width: 32px; }
        .sym { font-weight: 600; width: 80px; }
        .vol { text-align: right; font-family: monospace; }
        .spike { font-weight: bold; }

        .fg-container { margin-top: 8px; height: 8px; background: #333; border-radius: 4px; overflow: hidden; }
        .fg-fill { height: 100%; border-radius: 4px; transition: all 1s; }

        .footer {
            text-align: center;
            color: #555;
            font-size: 11px;
            margin: 30px 0 70px 0;
        }

        .refresh {
            text-align: center;
            color: var(--text-sec);
            font-size: 13px;
            margin-top: 10px;
        }

        .no-data { text-align: center; color: #666; padding: 20px; font-style: italic; }
    </style>
</head>
<body>

    <!-- Main Sentiment -->
    <div class="main-card" id="mainCard">
        <div class="sentiment-label">Overall Market Mood</div>
        <div class="sentiment-value" id="mood">Loading...</div>
        <div class="refresh" id="timestamp">Updating...</div>
    </div>

    <!-- Price Grid -->
    <div class="grid">
        <div class="card">
            <div class="label">BTC Price</div>
            <div class="value">$<span id="btc">-</span></div>
            <div class="sub" id="btc_chg">-</div>
        </div>
        <div class="card">
            <div class="label">ETH Price</div>
            <div class="value">$<span id="eth">-</span></div>
            <div class="sub" id="eth_chg">-</div>
        </div>
        <div class="card">
            <div class="label">BTC Dominance</div>
            <div class="value" id="dom">-</div>
        </div>
        <div class="card">
            <div class="label">Fear & Greed</div>
            <div class="value" id="fg_val">-</div>
            <div class="sub" id="fg_txt">—</div>
            <div class="fg-container"><div class="fg-fill" id="fg_bar"></div></div>
        </div>
    </div>

    <!-- Top Gainers -->
    <h3>Top 10 Gainers (24h)</h3>
    <div class="list" id="gainers"><div class="no-data">Loading...</div></div>

    <!-- Top Losers -->
    <h3>Top 10 Losers (24h)</h3>
    <div class="list" id="losers"><div class="no-data">Loading...</div></div>

    <!-- Volume Spikes -->
    <h3>Volume Spikes (4h vs 7d avg)</h3>
    <div class="list" id="volume"><div class="no-data">No extreme spikes</div></div>

    <!-- Volatile Coins -->
    <h3>Most Volatile (4h range ≥10%)</h3>
    <div class="list" id="volatile"><div class="no-data">Loading...</div></div>

    <div class="footer">
        Proven Crypto Bot V2 • Live Data • Updated every 15s
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        // Theme Support (Dark/Light)
        tg.onEvent('themeChanged', () => {
            if (tg.colorScheme === 'light') {
                document.documentElement.style.setProperty('--bg-color', '#ffffff');
                document.documentElement.style.setProperty('--card-bg', '#f0f0f0');
                document.documentElement.style.setProperty('--text-main', '#000000');
                document.documentElement.style.setProperty('--text-sec', '#666666');
            } else {
                document.documentElement.style.setProperty('--bg-color', '#0d0d0d');
                document.documentElement.style.setProperty('--card-bg', '#1a1a1a');
                document.documentElement.style.setProperty('--text-main', '#ffffff');
                document.documentElement.style.setProperty('--text-sec', '#888888');
            }
        });

        function setText(id, text) {
            const el = document.getElementById(id);
            if (el) el.innerText = text;
        }

        function renderList(containerId, items, isGainer = true) {
            const container = document.getElementById(containerId);
            if (!items || items.length === 0) {
                container.innerHTML = '<div class="no-data">No data available</div>';
                return;
            }
            container.innerHTML = items.map((c, i) => `
                <div class="item">
                    <span class="rank">${(i+1).toString().padStart(2, '0')}</span>
                    <span class="sym">${c.symbol}</span>
                    <span class="vol">$${Number(c.price).toLocaleString(undefined, {maximumFractionDigits: 2})}</span>
                    <span class="${isGainer ? 'green' : 'red'} spike">${c.change > 0 ? '+' : ''}${c.change.toFixed(2)}%</span>
                </div>
            `).join('');
        }

        async function loadAllData() {
            try {
                // Hole von deiner API (ersetze mit deiner Domain/Port)
                const res = await fetch('http://localhost:8000/api/webdashboard');  // ← Ändere zu deiner URL!
                if (!res.ok) throw new Error('API Error');
                const data = await res.json();

                // Mood
                setText('mood', data.sentiment || 'Neutral');
                const moodEl = document.getElementById('mood');
                if (data.sentiment?.includes('BULL')) moodEl.style.color = '#00ff88';
                else if (data.sentiment?.includes('BEAR')) moodEl.style.color = '#ff3040';
                else moodEl.style.color = '#ffff00';

                setText('timestamp', 'Updated: ' + new Date().toLocaleTimeString());

                // Prices
                setText('btc', Number(data.btc_price).toLocaleString(undefined, {maximumFractionDigits: 0}));
                setText('eth', Number(data.eth_price).toLocaleString(undefined, {maximumFractionDigits: 0}));
                document.getElementById('btc_chg').innerHTML = data.btc_change >= 0 ?
                    `<span class="green">+${data.btc_change.toFixed(2)}%</span>` :
                    `<span class="red">${data.btc_change.toFixed(2)}%</span>`;

                document.getElementById('eth_chg').innerHTML = data.eth_change >= 0 ?
                    `<span class="green">+${data.eth_change.toFixed(2)}%</span>` :
                    `<span class="red">${data.eth_change.toFixed(2)}%</span>`;

                setText('dom', data.btc_dominance?.toFixed(1) + '%');

                // Fear & Greed
                const fg = data.fear_greed || 50;
                setText('fg_val', fg);
                setText('fg_txt', data.fg_class || 'Neutral');
                const bar = document.getElementById('fg_bar');
                bar.style.width = fg + '%';
                bar.style.background = fg > 75 ? '#00ff00' : fg > 50 ? '#88ff88' : fg > 25 ? '#ffaa00' : '#ff0000';

                // Lists
                renderList('gainers', data.top_gainers, true);
                renderList('losers', data.top_losers, false);

                // Volume Spikes
                const volContainer = document.getElementById('volume');
                if (data.volume_spikes?.length > 0) {
                    volContainer.innerHTML = data.volume_spikes.map(s => `
                        <div class="item">
                            <span class="sym">${s.symbol}</span>
                            <span class="vol">$${s.usd_4h > 1e9 ? (s.usd_4h/1e9).toFixed(2)+'B' : (s.usd_4h/1e6).toFixed(1)+'M'}</span>
                            <span class="spike ${s.ratio >= 10 ? 'orange' : s.ratio >= 6 ? 'red' : 'green'}">${s.ratio.toFixed(1)}×</span>
                        </div>
                    `).join('');
                } else {
                    volContainer.innerHTML = '<div class="no-data">No extreme spikes</div>';
                }

                // Volatile
                renderList('volatile', data.volatile.map(v => ({...v, change: v.range})), false);  // Reuse render, change = range

            } catch (e) {
                console.error(e);
                setText('mood', 'Error loading data');
                document.getElementById('gainers').innerHTML = '<div class="no-data">API Error</div>';
            }
        }

        // Auto refresh every 15 seconds
        loadAllData();
        setInterval(loadAllData, 15000);

        // Telegram Main Button
        tg.MainButton.text = "Close Dashboard";
        tg.MainButton.show();
        tg.MainButton.onClick(() => tg.close());
    </script>
</body>
</html>
